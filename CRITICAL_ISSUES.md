# üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ò –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2 –¥–µ–∫–∞–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è –±–æ—Ç–∞:** main.py (6534 —Å—Ç—Ä–æ–∫–∏)  
**–°—Ç–∞—Ç—É—Å:** –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –∏–º–µ–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

---

## üìã –°–í–û–î–ö–ê

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –†–∏—Å–∫ |
|-----------|-----------|------------|------|
| üî¥ –ö–†–ò–¢–ò–ß–ù–û | –ë–î –±–µ–∑ timeout | ~70 –º–µ—Å—Ç | **–ó–∞–≤–∏—Å–∞–Ω–∏—è –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ** |
| üü† –í–´–°–û–ö–ò–ô | Silent exceptions | 50+ –º–µ—Å—Ç | **–ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö** |
| üü† –í–´–°–û–ö–ò–ô | Race conditions | 5-10 –º–µ—Å—Ç | **–î—É–±–ª–∏–∫–∞—Ç—ã –ø–ª–∞—Ç–µ–∂–µ–π** |
| üü° –°–†–ï–î–ù–ò–ô | Memory leak | 1 –º–µ—Å—Ç–æ | **–†–æ—Å—Ç –ø–∞–º—è—Ç–∏** |
| üü° –°–†–ï–î–ù–ò–ô | Subprocess –±–µ–∑ timeout | 3 –º–µ—Å—Ç–∞ | **–ó–∞–≤–∏—Å–∞–Ω–∏—è provision** |
| üü¢ –ù–ò–ó–ö–ò–ô | –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è | 10+ –º–µ—Å—Ç | **–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** |

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç —Å—Ä–æ—á–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º

---

## üî¥ –ü–†–û–ë–õ–ï–ú–ê #1: –ù–µ–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DB_TIMEOUT

### –û–ø–∏—Å–∞–Ω–∏–µ
–í –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `DB_TIMEOUT = 30` —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ SQLite, –Ω–æ **~70 –º–µ—Å—Ç** –æ—Ç–∫—Ä—ã–≤–∞—é—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ë–ï–ó —É–∫–∞–∑–∞–Ω–∏—è timeout.

### –†–∏—Å–∫–∏
- ‚ö†Ô∏è –ü—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –≤–∏—Å–µ—Ç—å **5+ –º–∏–Ω—É—Ç**
- ‚ö†Ô∏è Telegram API –∏–º–µ–µ—Ç —Ç–∞–π–º–∞—É—Ç **10 —Å–µ–∫—É–Ω–¥** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—Ç –æ—à–∏–±–∫–∏
- ‚ö†Ô∏è –ë–æ—Ç —Å—Ç–∞–Ω–µ—Ç –Ω–µ–æ—Ç–∑—ã–≤—á–∏–≤—ã–º –ø—Ä–∏ >50 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö

### –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –º–µ—Å—Ç

#### ‚ùå –ë–ï–ó timeout (–ü–õ–û–•–û):
```python
# –°—Ç—Ä–æ–∫–∞ 627 - init_db
async with aiosqlite.connect(DB_PATH) as db:
    await db.execute("CREATE TABLE IF NOT EXISTS users...")

# –°—Ç—Ä–æ–∫–∞ 664 - get_balance  
async with aiosqlite.connect(DB_PATH) as db:
    cur = await db.execute("SELECT balance FROM users...")

# –°—Ç—Ä–æ–∫–∞ 689 - set_balance
async with aiosqlite.connect(DB_PATH) as db:
    await db.execute("UPDATE users SET balance=?...")

# –°—Ç—Ä–æ–∫–∞ 730 - update_balance (–ö–†–ò–¢–ò–ß–ù–û!)
async with aiosqlite.connect(DB_PATH) as db:
    await db.execute("UPDATE users SET balance = balance + ?...")

# –°—Ç—Ä–æ–∫–∞ 1277 - handle_start
async with aiosqlite.connect(DB_PATH) as db:
    await db.execute("INSERT OR IGNORE INTO users...")

# –°—Ç—Ä–æ–∫–∞ 1675 - cmd_balance  
async with aiosqlite.connect(DB_PATH) as db:
    cur = await db.execute("SELECT balance FROM users...")

# –°—Ç—Ä–æ–∫–∞ 1829 - cmd_orders
async with aiosqlite.connect(DB_PATH) as db:
    cur = await db.execute("SELECT * FROM orders...")

# –°—Ç—Ä–æ–∫–∞ 2026 - cmd_myref
async with aiosqlite.connect(DB_PATH) as db:
    cur = await db.execute("SELECT COUNT(*) FROM users...")

# –°—Ç—Ä–æ–∫–∞ 2077 - menu_main
async with aiosqlite.connect(DB_PATH) as db:
    cur = await db.execute("SELECT balance FROM users...")

# –°—Ç—Ä–æ–∫–∞ 4728 - periodic_check_deposits (–ö–†–ò–¢–ò–ß–ù–û!)
async with aiosqlite.connect(DB_PATH) as db:
    cur = await db.execute("SELECT id FROM deposits...")
```

#### ‚úÖ –° timeout (–ü–†–ê–í–ò–õ–¨–ù–û):
```python
# –°—Ç—Ä–æ–∫–∞ 201
async with aiosqlite.connect(DB_PATH, timeout=DB_TIMEOUT) as db:
    await db.execute("UPDATE users...")

# –°—Ç—Ä–æ–∫–∞ 292
async with aiosqlite.connect(DB_PATH, timeout=DB_TIMEOUT) as db:
    await db.execute("INSERT INTO orders...")
```

### –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–≠—Ç–∞–ø 1:** –ù–∞–π—Ç–∏ –≤—Å–µ –º–µ—Å—Ç–∞ –±–µ–∑ timeout
```bash
grep -n "aiosqlite.connect(DB_PATH)" main.py | grep -v "timeout="
```

**–≠—Ç–∞–ø 2:** –ú–∞—Å—Å–æ–≤–∞—è –∑–∞–º–µ–Ω–∞
```python
# –ë–´–õ–û:
async with aiosqlite.connect(DB_PATH) as db:

# –°–¢–ê–õ–û:
async with aiosqlite.connect(DB_PATH, timeout=DB_TIMEOUT) as db:
```

**–≠—Ç–∞–ø 3:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î
- –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤—ã—Å–æ–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É (100+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ timeout —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ë–î –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π —á–µ—Ä–µ–∑ 30 —Å–µ–∫ –≤–º–µ—Å—Ç–æ 300 —Å–µ–∫

---

## üü† –ü–†–û–ë–õ–ï–ú–ê #2: Silent Exception Handling (50+ –º–µ—Å—Ç)

### –û–ø–∏—Å–∞–Ω–∏–µ
–ú–Ω–æ–∂–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤ `except Exception: pass` –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç –æ—à–∏–±–∫–∏ –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.

### –†–∏—Å–∫–∏
- üö® **–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã** - –æ—à–∏–±–∫–∏ –∏—Å—á–µ–∑–∞—é—Ç –±–µ—Å—Å–ª–µ–¥–Ω–æ
- üö® **–ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö** - –±–∞–ª–∞–Ω—Å –º–æ–∂–µ—Ç –Ω–µ –æ–±–Ω–æ–≤–∏—Ç—å—Å—è, –Ω–æ –Ω–∏–∫—Ç–æ –Ω–µ —É–∑–Ω–∞–µ—Ç
- üö® **–°–∫—Ä—ã—Ç—ã–µ –±–∞–≥–∏** - –ø—Ä–æ–±–ª–µ–º—ã –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –Ω–µ–∑–∞–º–µ—Ç–Ω–æ

### –ü—Ä–∏–º–µ—Ä—ã –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ—Å—Ç

```python
# –°—Ç—Ä–æ–∫–∞ 159-160: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
try:
    await db.execute("UPDATE users SET username=?, first_name=?...")
except Exception:
    pass  # ‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å - –Ω–∏–∫—Ç–æ –Ω–µ —É–∑–Ω–∞–µ—Ç

# –°—Ç—Ä–æ–∫–∞ 209-210: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
try:
    await db.execute("INSERT OR REPLACE INTO users...")
except Exception:
    pass  # ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ–∑–¥–∞–ª—Å—è - –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

# –°—Ç—Ä–æ–∫–∞ 411-412: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã deposit_bonuses
try:
    await db.execute("CREATE TABLE IF NOT EXISTS deposit_bonuses...")
except Exception:
    pass  # ‚ùå –¢–∞–±–ª–∏—Ü–∞ –Ω–µ —Å–æ–∑–¥–∞–ª–∞—Å—å - —Å–∏—Å—Ç–µ–º–∞ –±–æ–Ω—É—Å–æ–≤ —Å–ª–æ–º–∞–Ω–∞

# –°—Ç—Ä–æ–∫–∞ 468-469: –ú–∏–≥—Ä–∞—Ü–∏—è users
try:
    await db.execute("ALTER TABLE users ADD COLUMN ref_rate REAL")
except Exception:
    pass  # ‚ùå –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

# –°—Ç—Ä–æ–∫–∞ 700-701: update_balance (–ö–†–ò–¢–ò–ß–ù–û!)
try:
    async with aiosqlite.connect(DB_PATH) as db:
        cur = await db.execute("SELECT balance FROM users...")
except Exception:
    pass  # ‚ùå –ë–∞–ª–∞–Ω—Å –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è - –¥–µ–Ω—å–≥–∏ –ø–æ—Ç–µ—Ä—è–Ω—ã!
```

### –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ú–∏–Ω–∏–º—É–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–∞–∫—Å–∏–º—É–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

```python
# –ë–´–õ–û (–ü–õ–û–•–û):
try:
    await db.execute("UPDATE users SET balance = ?...")
except Exception:
    pass

# –°–¢–ê–õ–û (–•–û–†–û–®–û):
try:
    await db.execute("UPDATE users SET balance = ?...")
except Exception as e:
    logger.error(f"Failed to update balance for user {user_id}: {e}")
    # –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ù–ï –º–µ–Ω—è–µ—Ç—Å—è - –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

# –î–õ–Ø –ö–†–ò–¢–ò–ß–ù–´–• –û–ü–ï–†–ê–¶–ò–ô (–±–∞–ª–∞–Ω—Å, –ø–ª–∞—Ç–µ–∂–∏):
try:
    await db.execute("UPDATE users SET balance = ?...")
except Exception as e:
    logger.critical(f"CRITICAL: Balance update failed for user {user_id}: {e}")
    # –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
    if ADMIN_CHAT_ID:
        try:
            await context.bot.send_message(
                ADMIN_CHAT_ID, 
                f"‚ö†Ô∏è CRITICAL: Balance update failed for user {user_id}"
            )
        except:
            pass
```

**–≠—Ç–∞–ø—ã:**
1. –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ `except Exception: pass` –ø–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏
2. –î–æ–±–∞–≤–∏—Ç—å `logger.error()` –¥–ª—è –≤—Å–µ—Ö –º–µ—Å—Ç
3. –î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–±–∞–ª–∞–Ω—Å, –ø–ª–∞—Ç–µ–∂–∏) –¥–æ–±–∞–≤–∏—Ç—å `logger.critical()`
4. –ù–µ –º–µ–Ω—è—Ç—å –ª–æ–≥–∏–∫—É - —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üü† –ü–†–û–ë–õ–ï–ú–ê #3: Race Condition –≤ periodic_check_deposits

### –û–ø–∏—Å–∞–Ω–∏–µ
–§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–µ–ø–æ–∑–∏—Ç—ã —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è–º–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ –ë–î, —á—Ç–æ —Å–æ–∑–¥–∞—ë—Ç –æ–∫–Ω–æ –¥–ª—è race condition.

### –ö–æ–¥ –ø—Ä–æ–±–ª–µ–º—ã (—Å—Ç—Ä–æ–∫–∏ 4722-4765)

```python
async def periodic_check_deposits(context: ContextTypes.DEFAULT_TYPE):
    if JOB_LOCKS['deposits'].locked():
        return
    async with JOB_LOCKS['deposits']:
        # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ pending –¥–µ–ø–æ–∑–∏—Ç–æ–≤
        async with aiosqlite.connect(DB_PATH) as db:
            cur = await db.execute("SELECT id FROM deposits WHERE status='pending'...")
            ids = [r[0] for r in await cur.fetchall()]
        # ‚ö†Ô∏è –°–û–ï–î–ò–ù–ï–ù–ò–ï –ó–ê–ö–†–´–¢–û - –æ–∫–Ω–æ –¥–ª—è race condition
        
        for dep_id in ids:
            ok, credited, _ = await try_confirm_deposit(dep_id)
            if ok:
                # –®–∞–≥ 2: –ù–û–í–û–ï —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞
                async with aiosqlite.connect(DB_PATH) as db:
                    cur = await db.execute("SELECT user_id, expected_amount_usdt...")
                    # ‚ö†Ô∏è –ú–µ–∂–¥—É –®–∞–≥–æ–º 1 –∏ –®–∞–≥–æ–º 2 –¥–µ–ø–æ–∑–∏—Ç –º–æ–≥ –±—ã—Ç—å —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!
                    
                    # –®–∞–≥ 3: –ï–©–Å –û–î–ù–û —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –±–æ–Ω—É—Å–∞
                    async with aiosqlite.connect(DB_PATH, timeout=DB_TIMEOUT) as db2:
                        cur2 = await db2.execute("SELECT bonus_amount...")
                    
                    # –®–∞–≥ 4: –ó–∞—á–∏—Å–ª—è–µ–º (–º–æ–∂–µ—Ç –±—ã—Ç—å –¥—É–±–ª–∏–∫–∞—Ç!)
                    await context.bot.send_message(...)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π –ø—Ä–æ–±–ª–µ–º—ã

**–í—Ä–µ–º—è T1:** Periodic job —á–∏—Ç–∞–µ—Ç –¥–µ–ø–æ–∑–∏—Ç #123 (status='pending')  
**–í—Ä–µ–º—è T2:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç—ë–∂"  
**–í—Ä–µ–º—è T3:** try_confirm_deposit() –º–µ–Ω—è–µ—Ç status='confirmed' –∏ –∑–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å  
**–í—Ä–µ–º—è T4:** Periodic job —Å–Ω–æ–≤–∞ –≤—ã–∑—ã–≤–∞–µ—Ç try_confirm_deposit() - **–î–£–ë–õ–ò–ö–ê–¢ –ó–ê–ß–ò–°–õ–ï–ù–ò–Ø!**

### –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π**

```python
async def periodic_check_deposits(context: ContextTypes.DEFAULT_TYPE):
    if JOB_LOCKS['deposits'].locked():
        return
    
    async with JOB_LOCKS['deposits']:
        # –û–¥–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–∞ –≤–µ—Å—å —Ü–∏–∫–ª
        async with aiosqlite.connect(DB_PATH, timeout=DB_TIMEOUT) as db:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º FOR UPDATE –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–∞–ø–∏—Å–µ–π
            cur = await db.execute(
                "SELECT id FROM deposits WHERE status='pending' ORDER BY id DESC LIMIT 50"
            )
            ids = [r[0] for r in await cur.fetchall()]
            
            for dep_id in ids:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ü–†–Ø–ú–û –ü–ï–†–ï–î –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
                cur = await db.execute(
                    "SELECT status FROM deposits WHERE id = ?", 
                    (dep_id,)
                )
                row = await cur.fetchone()
                if not row or row[0] != 'pending':
                    continue  # –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
                ok, credited, _ = await try_confirm_deposit(dep_id)
                
                # –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤ try_confirm_deposit**

–í —Ñ—É–Ω–∫—Ü–∏–∏ `try_confirm_deposit()` –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É:

```python
async def try_confirm_deposit(dep_id: int):
    async with aiosqlite.connect(DB_PATH, timeout=DB_TIMEOUT) as db:
        # –ê—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        cur = await db.execute(
            "UPDATE deposits SET status='confirmed' WHERE id=? AND status='pending'",
            (dep_id,)
        )
        await db.commit()
        
        # –ï—Å–ª–∏ –Ω–µ –æ–±–Ω–æ–≤–∏–ª–æ—Å—å - –∑–Ω–∞—á–∏—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
        if cur.rowcount == 0:
            return False, 0.0, "Already processed"
        
        # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É...
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –æ–±–æ–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã.

---

## üü° –ü–†–û–ë–õ–ï–ú–ê #4: Memory Leak –≤ ORDER_LOCKS

### –û–ø–∏—Å–∞–Ω–∏–µ
–°–ª–æ–≤–∞—Ä—å `ORDER_LOCKS` —Ä–∞—Å—Ç—ë—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ - Lock —Å–æ–∑–¥–∞—ë—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞, –Ω–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è.

### –ö–æ–¥ –ø—Ä–æ–±–ª–µ–º—ã (—Å—Ç—Ä–æ–∫–∏ 73-79)

```python
ORDER_LOCKS: Dict[int, asyncio.Lock] = {}

def get_order_lock(order_id: int) -> asyncio.Lock:
    lock = ORDER_LOCKS.get(order_id)
    if lock is None:
        lock = asyncio.Lock()
        ORDER_LOCKS[order_id] = lock  # ‚ùå –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è!
    return lock
```

### –†–∞—Å—á—ë—Ç —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏

- 1 Lock ‚âà 80 –±–∞–π—Ç
- 1000 –∑–∞–∫–∞–∑–æ–≤ = 80 KB
- 10000 –∑–∞–∫–∞–∑–æ–≤ = 800 KB  
- 100000 –∑–∞–∫–∞–∑–æ–≤ = 8 MB
- **–ó–∞ –≥–æ–¥ (50K –∑–∞–∫–∞–∑–æ–≤) = 4 MB** - –Ω–µ—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ, –Ω–æ —Ä–∞—Å—Ç—ë—Ç

### –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–í–∞—Ä–∏–∞–Ω—Ç 1: –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ (–ø—Ä–æ—Å—Ç–æ–π)**

```python
async def cleanup_order_locks():
    """–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ locks –¥–ª—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤"""
    if len(ORDER_LOCKS) < 1000:
        return  # –ù–µ —Ç—Ä–∞—Ç–∏–º –≤—Ä–µ–º—è, –µ—Å–ª–∏ –º–∞–ª–æ
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
    async with aiosqlite.connect(DB_PATH, timeout=DB_TIMEOUT) as db:
        cur = await db.execute(
            "SELECT id FROM orders WHERE status IN ('pending', 'processing', 'provisioned')"
        )
        active_ids = {row[0] for row in await cur.fetchall()}
    
    # –£–¥–∞–ª—è–µ–º locks –¥–ª—è –ù–ï–∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
    to_remove = [oid for oid in ORDER_LOCKS if oid not in active_ids]
    for oid in to_remove:
        ORDER_LOCKS.pop(oid, None)
    
    if to_remove:
        logger.info(f"Cleaned up {len(to_remove)} order locks")

# –î–æ–±–∞–≤–∏—Ç—å –≤ job_queue:
app.job_queue.run_repeating(cleanup_order_locks, interval=3600, first=600)
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: LRU Cache —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞**

```python
from collections import OrderedDict

MAX_ORDER_LOCKS = 5000

class LRUOrderLocks:
    def __init__(self, max_size: int):
        self.locks = OrderedDict()
        self.max_size = max_size
    
    def get(self, order_id: int) -> asyncio.Lock:
        if order_id in self.locks:
            # –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –∫–æ–Ω–µ—Ü (recently used)
            self.locks.move_to_end(order_id)
            return self.locks[order_id]
        
        # –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π lock
        lock = asyncio.Lock()
        self.locks[order_id] = lock
        
        # –£–¥–∞–ª–∏—Ç—å —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π, –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç
        if len(self.locks) > self.max_size:
            self.locks.popitem(last=False)
        
        return lock

ORDER_LOCKS = LRUOrderLocks(MAX_ORDER_LOCKS)

def get_order_lock(order_id: int) -> asyncio.Lock:
    return ORDER_LOCKS.get(order_id)
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í–∞—Ä–∏–∞–Ω—Ç 1 (–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞) - –ø—Ä–æ—â–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ.

---

## üü° –ü–†–û–ë–õ–ï–ú–ê #5: Subprocess –±–µ–∑ timeout

### –û–ø–∏—Å–∞–Ω–∏–µ
–í—ã–∑–æ–≤—ã `subprocess.run()` –Ω–µ –∏–º–µ—é—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `timeout`, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∑–∞–≤–∏—Å–∞–Ω–∏—é.

### –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –º–µ—Å—Ç

```python
# –°—Ç—Ä–æ–∫–∞ 4533 - run_provision_subprocess
return subprocess.run(
    [sys.executable, script, '--order-id', str(order_id), '--db', DB_PATH],
    cwd=BASE_DIR,
    capture_output=True,
    text=True
    # ‚ùå –ù–µ—Ç timeout! –ï—Å–ª–∏ provision –∑–∞–≤–∏—Å–Ω–µ—Ç - –±—É–¥–µ—Ç –≤–∏—Å–µ—Ç—å –≤–µ—á–Ω–æ
)

# –°—Ç—Ä–æ–∫–∞ 5476 - manage scripts
return subprocess.run(
    args,
    cwd=BASE_DIR,
    capture_output=True,
    text=True
    # ‚ùå –ù–µ—Ç timeout!
)

# –°—Ç—Ä–æ–∫–∞ 6371 - –¥—Ä—É–≥–∏–µ subprocess
return subprocess.run(
    # ...
    # ‚ùå –ù–µ—Ç timeout!
)
```

### –†–∏—Å–∫–∏

- ‚ö†Ô∏è –ó–∞–≤–∏—Å—à–∏–π provision –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç PROVISION_SEM
- ‚ö†Ô∏è –ü–æ—Å–ª–µ 5 –∑–∞–≤–∏—Å—à–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (MAX_PROVISION_CONCURRENCY=5) –±–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã
- ‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –∂–¥–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ

### –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```python
# –ë–´–õ–û (–ü–õ–û–•–û):
return subprocess.run(
    [sys.executable, script, '--order-id', str(order_id)],
    cwd=BASE_DIR,
    capture_output=True,
    text=True
)

# –°–¢–ê–õ–û (–•–û–†–û–®–û):
PROVISION_TIMEOUT = 1800  # 30 –º–∏–Ω—É—Ç - –º–∞–∫—Å–∏–º—É–º –¥–ª—è provision
MANAGE_TIMEOUT = 300      # 5 –º–∏–Ω—É—Ç - –º–∞–∫—Å–∏–º—É–º –¥–ª—è manage –æ–ø–µ—Ä–∞—Ü–∏–π

try:
    return subprocess.run(
        [sys.executable, script, '--order-id', str(order_id)],
        cwd=BASE_DIR,
        capture_output=True,
        text=True,
        timeout=PROVISION_TIMEOUT  # ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ timeout
    )
except subprocess.TimeoutExpired:
    logger.error(f"Provision script timeout for order {order_id}")
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É –≤–º–µ—Å—Ç–æ –≤–µ—á–Ω–æ–≥–æ –∑–∞–≤–∏—Å–∞–Ω–∏—è
    return subprocess.CompletedProcess(
        args=[], returncode=1, stdout='', stderr='Timeout expired'
    )
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è timeout:**
- **Provision scripts:** 1800 —Å–µ–∫ (30 –º–∏–Ω) - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–ª–≥–æ–π
- **Manage scripts:** 300 —Å–µ–∫ (5 –º–∏–Ω) - –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –±—ã—Å—Ç—Ä—ã–µ
- **–î—Ä—É–≥–∏–µ subprocess:** 60 —Å–µ–∫ (1 –º–∏–Ω) - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

---

## üü¢ –ü–†–û–ë–õ–ï–ú–ê #6: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –û–ø–∏—Å–∞–Ω–∏–µ
–ù–µ –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º.

### –ü—Ä–∏–º–µ—Ä—ã

**1. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ñ–∏–≥–æ–≤**
```python
# –ì–¥–µ-—Ç–æ –≤ –∫–æ–¥–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
max_configs = int(update.message.text)
# ‚ùå –ß—Ç–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª 0? -5? 9999999?
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
max_configs = int(update.message.text)
if not (1 <= max_configs <= 250):
    await update.message.reply_text("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 250")
    return
```

**2. IP –∞–¥—Ä–µ—Å–∞**
```python
# –ü—Ä–∏ —Ä—É—á–Ω–æ–º provision
ip = parts[0]  # –ë–µ—Ä—ë–º –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å
# ‚ùå –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç IP
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
import ipaddress

try:
    ip_obj = ipaddress.ip_address(parts[0])
    if ip_obj.is_private:
        await update.message.reply_text("–ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ IP")
        return
    ip = str(ip_obj)
except ValueError:
    await update.message.reply_text("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π IP –∞–¥—Ä–µ—Å")
    return
```

**3. Email (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)**
```python
email = data.get("email")
# ‚ùå –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
import re

EMAIL_REGEX = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'

if email and not re.match(EMAIL_REGEX, email):
    logger.warning(f"Invalid email format: {email}")
    email = None
```

### –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
3. –ù–µ –º–µ–Ω—è—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª - —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏

---

## üìÖ –ü–õ–ê–ù –ü–û–≠–¢–ê–ü–ù–û–ì–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (2-3 –¥–Ω—è)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1.1: –î–æ–±–∞–≤–∏—Ç—å DB_TIMEOUT –≤–µ–∑–¥–µ**
- –ü–æ–∏—Å–∫: `grep -n "aiosqlite.connect(DB_PATH)" | grep -v "timeout="`
- –ó–∞–º–µ–Ω–∞: –¥–æ–±–∞–≤–∏—Ç—å `, timeout=DB_TIMEOUT` –≤ ~70 –º–µ—Å—Ç
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ë–î
- **–†–∏—Å–∫:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π - —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1.2: –ó–∞–º–µ–Ω–∏—Ç—å silent exceptions –Ω–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
- –ü–æ–∏—Å–∫: `grep -n "except Exception:" -A 1 | grep "pass"`
- –ó–∞–º–µ–Ω–∞: –¥–æ–±–∞–≤–∏—Ç—å `logger.error()` –≤ ~50 –º–µ—Å—Ç
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ª–æ–≥–∏ –ø–∏—à—É—Ç—Å—è
- **–†–∏—Å–∫:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π - —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1.3: –ò—Å–ø—Ä–∞–≤–∏—Ç—å race condition –≤ periodic_check_deposits**
- –ò–∑–º–µ–Ω–∏—Ç—å: —Ñ—É–Ω–∫—Ü–∏—è periodic_check_deposits (—Å—Ç—Ä–æ–∫–∏ 4722-4800)
- –î–æ–±–∞–≤–∏—Ç—å: –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ–ø–æ–∑–∏—Ç–∞
- **–†–∏—Å–∫:** –°—Ä–µ–¥–Ω–∏–π - –º–µ–Ω—è–µ–º –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π

### –§–∞–∑–∞ 2: –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (1-2 –¥–Ω—è)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2.1: –î–æ–±–∞–≤–∏—Ç—å timeout –≤ subprocess**
- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã PROVISION_TIMEOUT, MANAGE_TIMEOUT
- –û–±–µ—Ä–Ω—É—Ç—å subprocess.run –≤ try/except TimeoutExpired
- **–†–∏—Å–∫:** –ù–∏–∑–∫–∏–π - –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞—â–∏—Ç—É
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å—à–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2.2: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—á–∏—Å—Ç–∫—É ORDER_LOCKS**
- –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é cleanup_order_locks()
- –î–æ–±–∞–≤–∏—Ç—å –≤ job_queue —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 1 —á–∞—Å
- **–†–∏—Å–∫:** –ù–∏–∑–∫–∏–π - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°—Ç–∞–±–∏–ª—å–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

### –§–∞–∑–∞ 3: –ñ–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (1 –¥–µ–Ω—å)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3.1: –£–ª—É—á—à–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
- –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ validate_ip(), validate_email()
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –º–µ—Å—Ç–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
- **–†–∏—Å–∫:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π - —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–∞—Ü–∏—è
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –§–∞–∑–∞ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (2-3 –¥–Ω—è)

1. **–ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - 100+ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤ –ë–î
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ edge cases**
   - –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–¥–Ω–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞
   - –ó–∞–≤–∏—Å–∞–Ω–∏–µ provision —Å–∫—Ä–∏–ø—Ç–∞
   - –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ ORDER_LOCKS

3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**
   - –ê–ª–µ—Ä—Ç—ã –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ (logger.critical)
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–∞ ORDER_LOCKS
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–∞–π–º–∞—É—Ç–æ–≤ –ë–î

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –ü–ï–†–ï–î –î–ï–ü–õ–û–ï–ú

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] –í—Å–µ `aiosqlite.connect()` –∏–º–µ—é—Ç `timeout=DB_TIMEOUT`
- [ ] –ù–µ—Ç `except Exception: pass` –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] periodic_check_deposits –∑–∞—â–∏—â—ë–Ω –æ—Ç race condition
- [ ] subprocess.run –∏–º–µ–µ—Ç timeout
- [ ] cleanup_order_locks –¥–æ–±–∞–≤–ª–µ–Ω –≤ job_queue
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª –ª–æ–≥–æ–≤)
- [ ] –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] –ü—Ä–æ–≤–µ–¥–µ–Ω–æ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø –ë–î –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

---

## üìä –ú–ï–¢–†–ò–ö–ò –î–õ–Ø –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:

1. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ timeout –æ—à–∏–±–æ–∫ –ë–î**
   - `grep "timeout" bot.log | wc -l`
   - –ù–æ—Ä–º–∞: <10 –≤ —á–∞—Å

2. **–†–∞–∑–º–µ—Ä ORDER_LOCKS**
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å `len(ORDER_LOCKS)` —Ä–∞–∑ –≤ —á–∞—Å
   - –ù–æ—Ä–º–∞: <1000

3. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ subprocess timeout**
   - `grep "Provision script timeout" bot.log`
   - –ù–æ—Ä–º–∞: 0

4. **–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏**
   - `grep "CRITICAL" bot.log`
   - –ù–æ—Ä–º–∞: 0

5. **Race condition –≤ –¥–µ–ø–æ–∑–∏—Ç–∞—Ö**
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã: `SELECT user_id, COUNT(*) FROM deposits GROUP BY user_id HAVING COUNT(*) > 1`
   - –ù–æ—Ä–º–∞: 0

---

## üîß –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–µ—Å—Ç –±–µ–∑ timeout

```bash
# –ù–∞–π—Ç–∏ –≤—Å–µ –º–µ—Å—Ç–∞ –±–µ–∑ timeout
grep -n "aiosqlite.connect(DB_PATH)" main.py | grep -v "timeout=" > missing_timeout.txt
```

### –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ silent exceptions

```bash
# –ù–∞–π—Ç–∏ –≤—Å–µ except Exception: pass
grep -n "except Exception:" main.py -A 1 | grep -B 1 "pass$" > silent_exceptions.txt
```

### –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è race condition

```python
# test_race_condition.py
import asyncio
import aiosqlite

async def simulate_concurrent_deposit_check(dep_id):
    """–°–∏–º—É–ª–∏—Ä—É–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –¥–µ–ø–æ–∑–∏—Ç–∞"""
    tasks = [
        try_confirm_deposit(dep_id),
        try_confirm_deposit(dep_id),
        try_confirm_deposit(dep_id)
    ]
    results = await asyncio.gather(*tasks)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∑–∞—á–∏—Å–ª–µ–Ω
    credited_count = sum(1 for r in results if r[0])
    assert credited_count == 1, f"Expected 1 credit, got {credited_count}"
```

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
–ë–æ—Ç **—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–µ–Ω**, –Ω–æ –∏–º–µ–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏:
- –í—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ (>50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
- –î–æ–ª–≥–æ–π —Ä–∞–±–æ—Ç–µ (memory leak —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü—ã)
- –†–µ–¥–∫–∏—Ö —Å–±–æ—è—Ö (race conditions)

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
–ë–æ—Ç —Å—Ç–∞–Ω–µ—Ç:
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω—ã–º –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
- ‚úÖ –ó–∞—â–∏—â—ë–Ω–Ω—ã–º –æ—Ç race conditions
- ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä—É–µ–º—ã–º (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫)
- ‚úÖ –£—Å—Ç–æ–π—á–∏–≤—ã–º –∫ –∑–∞–≤–∏—Å–∞–Ω–∏—è–º (timeouts –≤–µ–∑–¥–µ)

### –í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- **–ú–∏–Ω–∏–º—É–º (–§–∞–∑–∞ 1):** 2-3 –¥–Ω—è
- **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è (–§–∞–∑—ã 1-2):** 4-5 –¥–Ω–µ–π  
- **–ü–æ–ª–Ω–æ—Å—Ç—å—é (–§–∞–∑—ã 1-4):** 7-10 –¥–Ω–µ–π

### –†–∏—Å–∫–∏ –ø—Ä–∏ –ù–ï–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
- üî¥ –ü–æ—Ç–µ—Ä—è –¥–µ–Ω–µ–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥—É–±–ª–∏–∫–∞—Ç—ã/–Ω–µ–¥–æ–∑–∞—á–∏—Å–ª–µ–Ω–∏—è)
- üî¥ –ó–∞–≤–∏—Å–∞–Ω–∏—è –±–æ—Ç–∞ –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ
- üî¥ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–∞–π—Ç–∏ –ø—Ä–∏—á–∏–Ω—É —Å–±–æ–µ–≤
- üü† –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π —Ä–æ—Å—Ç –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –§–∞–∑—É 1 (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã) **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ**, –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ø–æ –º–µ—Ä–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏.
